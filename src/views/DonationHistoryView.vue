<!--
  GiftHistoryView.vue
  Displays a list of all gifts for the current wedding event.
  - Loads gift records from localForage (offline-first)
  - Mobile-first, touch-friendly table/list
  - Ghana-optimized: clear, simple, and fast
  - Stratonea-compliant: full file, clear comments, ready to copy-paste
  - ===== [New Feature] START ===== Filter gifts by current event to prevent mixing ===== [New Feature] END =====
  - ===== [New Feature] START ===== Reorder columns and add total section ===== [New Feature] END =====
-->


<template>
  <div class="min-h-screen bg-gray-50 text-gray-800">
    <!-- ===== App Header (Stratonea Standard) ===== -->
    

    <main class="container mx-auto p-4 md:p-8">
      <!-- ===== Show current event name ===== -->
      <h1 class="text-xl font-bold mb-2 text-center">
        Gifts for:
        <span class="text-primary">
          {{ currentEvent?.eventName || 'No Event Selected' }}
        </span>
      </h1>
      <p class="text-gray-600 text-center mb-6">
        View all gifts received for this event. Works offline.
      </p>

      <!-- ===== Loading State ===== -->
      <div v-if="isLoading" class="flex justify-center items-center py-10">
        <span class="text-primary font-semibold">Loading gifts...</span>
      </div>

      <!-- ===== No Donations State ===== -->
      <div v-else-if="filteredGifts.length === 0" class="text-center text-gray-500 py-10">
        No gifts found yet for this event.
      </div>

      <!-- ===== Donations Table/List ===== -->
      <div v-else class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg shadow-md">
          <thead>
            <tr class="bg-gray-100 text-xs uppercase text-gray-600">
              <th class="py-3 px-2">#</th>
              <th class="py-3 px-2">Giver</th>
              <th class="py-3 px-2">Date</th>
              <th class="py-3 px-2">Receipt</th>
              <th class="py-3 px-2">Payment</th>
              <th class="py-3 px-2">Phone</th>
              <th class="py-3 px-2">Value</th>
            </tr>
          </thead>
          <tbody>
            <tr
              v-for="(gift, idx) in filteredGifts"
              :key="gift.receiptNumber"
              class="border-b last:border-b-0 hover:bg-gray-50 transition"
            >
              <td class="py-2 px-2 text-center font-semibold">{{ idx + 1 }}</td>
              <td class="py-2 px-2 font-medium">{{ gift.giverName }}</td>
              <td class="py-2 px-2 whitespace-nowrap">{{ gift.dateTime }}</td>
              <td class="py-2 px-2 font-mono text-xs">{{ gift.receiptNumber }}</td>
              <td class="py-2 px-2">{{ gift.paymentMode }}</td>
              <td class="py-2 px-2">{{ gift.phoneNumber || '-' }}</td>
              <td class="py-2 px-2 text-green-700 font-bold">GHS {{ Number(gift.giftValue).toFixed(2) }}</td>
            </tr>
          </tbody>
        </table>
        <!-- ===== [New Feature] START ===== Total Section ===== -->
        <div class="flex justify-end mt-4 pr-2">
          <div class="bg-gray-100 rounded-lg px-6 py-3 text-lg font-bold text-green-800 shadow-sm">
            Total: GHS {{ totalValue }}
          </div>
        </div>
        <!-- ===== [New Feature] END ===== -->
      </div>

      <!-- ===== Back Button ===== -->
      <div class="mt-8 flex justify-center">
        <router-link
          to="/"
          class="bg-primary text-white font-semibold py-2 px-6 rounded-lg hover:bg-primary-dark transition-colors"
        >
          Back to Home
        </router-link>
      </div>
    </main>
  </div>
</template>

<script setup lang="ts">
// ===== File-Level Documentation =====
/**
 * GiftHistoryView.vue
 * - Loads and displays all gift records from localForage
 * - Ghana-optimized: mobile-first, offline-first, clear comments
 * - Stratonea-compliant: full file, ready to copy-paste
 * - ===== [New Feature] START ===== Filter gifts by current event to prevent mixing ===== [New Feature] END =====
 * - ===== [New Feature] START ===== Reorder columns and add total section ===== [New Feature] END =====
 */

// ===== Imports =====
import { ref, onMounted, computed } from 'vue'
import localforage from 'localforage'


// ===== Types & Interfaces =====
/**
 * Represents a single gift record.
 */
interface GiftRecord {
  eventName: string
  giverName: string
  giftDescription: string
  giftValue: number
  paymentMode: string
  phoneNumber: string
  photoPreview?: string
  receiptNumber: string
  dateTime: string
}

// ===== Reactive State =====
const gifts = ref<GiftRecord[]>([])
const isLoading = ref(true)

// ===== Store and load current event for filtering =====
const currentEvent = ref<{ eventName: string } | null>(null)

/**
 * Loads the current event from localStorage.
 * This is used to filter donations so only those for the active event are shown.
 */
function loadCurrentEvent() {
  try {
    const event = localStorage.getItem('wedding-event')
    if (event) {
      currentEvent.value = JSON.parse(event)
    }
  } catch {
    currentEvent.value = null
  }
}

// ===== Filtered donations for current event only =====
/**
 * Only show donations for the current event to avoid mixing records.
 */
const filteredGifts = computed(() => {
  if (!currentEvent.value) return []
  return gifts.value.filter(
    g => g.eventName === currentEvent.value!.eventName
  )
})

// ===== [New Feature] START ===== Total Amount Calculation =====
/**
 * Calculates the total amount for all filtered donations.
 */
const totalValue = computed(() => {
  return filteredGifts.value
    .reduce((sum, g) => sum + Number(g.giftValue), 0)
    .toFixed(2)
})
// ===== [New Feature] END =====

// ===== Helper Functions =====

/**
 * Loads all donation records from localForage.
 * Sets loading state and handles errors in simple English.
 */
async function loadGifts() {
  isLoading.value = true
  try {
    const result = await localforage.getItem<GiftRecord[]>('stratonea-wedding-gifts')
    gifts.value = Array.isArray(result) ? result : []
  } catch (e) {
    // Simple error message for Ghanaian users
    alert('Could not load gift records. Please try again.')
    gifts.value = []
  } finally {
    isLoading.value = false
  }
}

// ===== Lifecycle =====
onMounted(() => {
  loadCurrentEvent()
  loadGifts()
})
</script>
